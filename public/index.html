<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./styles.css">
  <title>Video Compression Demo</title>
</head>
<body>
  <div class="container">
    <h1>Video Compression</h1>

    <button id="infoBtn" class="info-button">–ö–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç –º–Ω–µ –≤—ã–±—Ä–∞—Ç—å?</button>

    <input type="file" id="uploader" accept="video/*">
    <p id="originalSize" class="file-size-info"></p>

    <div class="video-container">
      <video id="video" controls></video>
    </div>

    <div class="formats">
      <strong>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong><br>
      <label><input type="checkbox" value="gif" checked> GIF</label>
      <label><input type="checkbox" value="mp4"> MP4</label>
      <label><input type="checkbox" value="webm"> WebM</label>
    </div>

    <div class="controls">
      <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å–µ–∫): <input type="number" id="duration" value="3" min="1" max="10" style="width:60px;"></label>
      <label>FPS: <input type="number" id="fps" value="10" min="1" max="60" style="width:60px;"></label>
      <label>–®–∏—Ä–∏–Ω–∞: <input type="number" id="width" value="320" min="100" max="1920" style="width:80px;"></label>
    </div>

    <button id="convertBtn">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <p id="loadingText"></p>

    <div class="output" id="output"></div>
  </div>

  <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal-content">
      <span id="closeModal" class="modal-close">&times;</span>
      <h2>–ö–∞–∫ –º–Ω–µ –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ñ–æ—Ä–º–∞—Ç?</h2>
      <div class="modal-body">
        <p>–ß—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –æ—Ç–≤–µ—Ç—å—Ç–µ —Å–µ–±–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:</p>
        <ul>
          <li><strong>–ë—É–¥–µ—Ç –ª–∏ –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ?</strong><br>
            –ï—Å–ª–∏ –¥–∞, —Ç–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <strong>WebM</strong> (–æ—Ç–∫—Ä—ã—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç, –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏). WebM —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–∏ —Ä–∞–∑—É–º–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ —Ñ–∞–π–ª–∞.</li>
          <li><strong>–ù—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ?</strong><br>
            –¢–æ–≥–¥–∞ –≤—ã–±–∏—Ä–∞–µ–º <strong>MP4</strong> —Å –∫–æ–¥–µ–∫–æ–º H.265 (libx265). H.265 –¥–∞—ë—Ç –ª—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ, —á–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–¥–µ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, H.264), –Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω–µ—á–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç H.265. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ H.264 (libx264), –Ω–æ –≤ —ç—Ç–æ–º –∫–æ–¥–µ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º libx264.</li>
          <li><strong>–ù—É–∂–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–µ–∑ –∑–≤—É–∫–∞ (–º–µ–º, –ª—É–ø)?</strong><br>
            –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø–æ–¥–æ–π–¥—ë—Ç <strong>GIF</strong>. GIF –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–≤—É–∫ –∏ —Ü–≤–µ—Ç–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø–∞–ª–∏—Ç—Ä–æ–π 256 –æ—Ç—Ç–µ–Ω–∫–æ–≤, –Ω–æ –æ—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π –∏ –ª—É–ø–æ–≤. –ù–∞—à –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞–ª–∏—Ç—Ä—É (—á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã palettegen/paletteuse) –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞.</li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      createFFmpeg,
      fetchFile,
    } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.5/+esm";

    const ffmpeg = createFFmpeg({ log: true });

    const uploader        = document.getElementById("uploader");
    const video           = document.getElementById("video");
    const convertBtn      = document.getElementById("convertBtn");
    const outputEl        = document.getElementById("output");
    const formatInputs    = document.querySelectorAll(".formats input[type=checkbox]");
    const durationInput   = document.getElementById("duration");
    const fpsInput        = document.getElementById("fps");
    const widthInput      = document.getElementById("width");
    const originalSizeEl  = document.getElementById("originalSize");
    const loadingText     = document.getElementById("loadingText");

    const infoBtn         = document.getElementById("infoBtn");
    const modalOverlay    = document.getElementById("modalOverlay");
    const closeModal      = document.getElementById("closeModal");

    let fileData;

    // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ —Ä–∞–∑–º–µ—Ä
    uploader.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      fileData = file;
      video.src = URL.createObjectURL(file);

      const sizeKB = (file.size / 1024).toFixed(2);
      originalSizeEl.textContent = `–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª: ${sizeKB} KB`;
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function showLoadingText() {
      loadingText.textContent = "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, —Ñ–∞–π–ª—ã –≥–æ—Ç–æ–≤—è—Ç—Å—è...";
    }
    function hideLoadingText() {
      loadingText.textContent = "";
    }

    convertBtn.addEventListener("click", async () => {
      if (!fileData) return alert("Please upload a video first!");

      const selectedFormats = Array.from(formatInputs)
        .filter((i) => i.checked)
        .map((i) => i.value);
      if (selectedFormats.length === 0) return alert("Select at least one format");

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å—å ¬´–ü–æ–¥–æ–∂–¥–∏—Ç–µ‚Ä¶¬ª
      showLoadingText();

      try {
        if (!ffmpeg.isLoaded()) {
          await ffmpeg.load();
        }
        outputEl.innerHTML = "";

        const inputExt  = fileData.name.split(".").pop();
        const inputName = `input.${inputExt}`;
        await ffmpeg.FS("writeFile", inputName, await fetchFile(fileData));

        const duration = durationInput.value;
        const fps      = fpsInput.value;
        const width    = widthInput.value;
        const scaleArg = `scale=${width}:-1:flags=lanczos`;

        for (const fmt of selectedFormats) {
          const outName = `output.${fmt}`;
          let args = [
            "-i", inputName,
            "-t", duration,
            "-vf", `fps=${fps},${scaleArg}`
          ];

          if (fmt === "gif") {
            // 1-–π –ø—Ä–æ—Ö–æ–¥: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–∞–ª–∏—Ç—Ä—É
            await ffmpeg.run(
              "-i", inputName,
              "-t", duration,
              "-vf", `fps=${fps},${scaleArg},palettegen=stats_mode=diff`,
              "-y", "palette.png"
            );
            // 2-–π –ø—Ä–æ—Ö–æ–¥: –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–ª–∏—Ç—Ä—É
            args = [
              "-i", inputName,
              "-i", "palette.png",
              "-t", duration,
              "-lavfi", `fps=${fps},${scaleArg} [x]; [x][1:v] paletteuse=dither=bayer`,
              outName
            ];
          } else if (fmt === "mp4") {
            args.push(
              "-c:v", "libx264",
              "-pix_fmt", "yuv420p",
              "-preset", "fast",
              "-movflags", "faststart",
              outName
            );
          } else if (fmt === "webm") {
            args.push("-c:v", "libvpx", "-b:v", "1M", outName);
          }

          console.log("Running ffmpeg with args:", args);
          await ffmpeg.run(...args);

          // –ß—Ç–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          const data = ffmpeg.FS("readFile", outName);
          const mimeTypes = {
            gif:  "image/gif",
            mp4:  "video/mp4",
            webm: "video/webm"
          };
          const blob = new Blob([data.buffer], { type: mimeTypes[fmt] || "application/octet-stream" });
          const url  = URL.createObjectURL(blob);

          const item = document.createElement("div");
          item.className = "output-item";
          item.innerHTML = `<h3>${fmt.toUpperCase()} Output</h3>`;

          if (fmt === "gif") {
            const img = document.createElement("img");
            img.src = url;
            item.appendChild(img);
          } else {
            const vid = document.createElement("video");
            vid.src = url;
            vid.controls = true;
            vid.style.maxWidth = "100%";
            item.appendChild(vid);
          }

          // –†–∞–∑–º–µ—Ä –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
          const sizeKB_fmt = (data.buffer.byteLength / 1024).toFixed(2);
          const sizeEl = document.createElement("p");
          sizeEl.textContent = `Size: ${sizeKB_fmt} KB`;
          item.appendChild(sizeEl);

          // –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
          const downloadLink = document.createElement("a");
          downloadLink.href = url;
          downloadLink.download = outName;
          downloadLink.textContent = "üì• –°–∫–∞—á–∞—Ç—å";
          downloadLink.style.display = "inline-block";
          downloadLink.style.marginTop = "8px";
          item.appendChild(downloadLink);

          outputEl.appendChild(item);
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:", err);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.");
      } finally {
        // –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–¥–ø–∏—Å—å, –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        hideLoadingText();
      }
    });

    // ===== JS –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ) =====
    infoBtn.addEventListener("click", () => {
      modalOverlay.style.display = "flex";
    });
    closeModal.addEventListener("click", () => {
      modalOverlay.style.display = "none";
    });
    modalOverlay.addEventListener("click", (e) => {
      if (e.target === modalOverlay) {
        modalOverlay.style.display = "none";
      }
    });
    // ======================================================
  </script>
</body>
</html>
